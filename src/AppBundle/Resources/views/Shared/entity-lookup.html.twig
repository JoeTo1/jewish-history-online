{% macro head(entity_lookup, bibitem_lookup, glossary_lookup) %}
    <script>
    var entityLookup = {{ entity_lookup|json_encode|raw }};
    var bibitemLookup = {{ bibitem_lookup|json_encode|raw }};
    var glossaryLookup = {{ glossary_lookup|json_encode|raw }};

    function buildGlossaryInfo($el) {
        var url = {{ path('glossary-index')|json_encode|raw }};
        var term = $el.data('title');
        if (term in glossaryLookup) {
            var info = glossaryLookup[term];
            var url_detail = url + '#' + info.slug;
            return {
                "url" :  url_detail,
                "title" : info.name + ': ' + info.headline
            };
        }
        return null;
    }

    function initGlossary(selector) {
        var selector_full = '.glossary';
        if ('' !== selector) {
            selector_full = selector + ' ' + selector_full;
        }

        $( '.glossary' ).each (function ( index ) {
            var $el = $( this );
            var info = buildGlossaryInfo($el);
            if (null != info) {
                $el.addClass('hoverable');
                $el.click(function() {
                    window.location = info.url;
                    return false;
                });
                $el.tooltip({
                    title: info.title,
                    html: false /*,
                    delay: { hide: 350 } */
                });
            }
            else {
                // remove <a href=""></a> but keep content
                // see http://stackoverflow.com/a/4232971 also for a better performing solution
                $el.contents().unwrap();
                /*
                var el = $el.get(0);
                var parent = el.parentNode;
                while( el.firstChild ) {
                    parent.insertBefore(  el.firstChild, el );
                }
                parent.removeChild(el);
                */
            }
        });
    }

    function initNote(element) {
        var id_sel = $( element ).attr('href');
        // console.log('Note ' + $( id_sel ).html());
        $( element ).tooltip({
            title: $( id_sel ).html(),
            html: true  /*,
            delay: { hide: 350 } */
        });
    }

    function initNotes(selector) {
        var selector_full = '.editorial-marker';
        if ('' !== selector) {
            selector_full = selector + ' ' + selector_full;
        }

        $( selector_full ).each(function( index ) {
            var sibling = this.previousSibling;
            if (sibling.nodeType == 3) {
                // text-node
                sibling.nodeValue = sibling.nodeValue.replace(/\s+$/g, '');
            }
            initNote(this)
        });
    }

    function initEntityRef(selector) {
        // link entities
        var selector_full = '.entity-ref';
        if ('' !== selector) {
            selector_full = selector + ' ' + selector_full;
        }

        $( selector_full ).each(function( index ) {
            var $el = $( this );
            var type = $el.data('type');
            var uri = $el.data('uri');
            var info = entityLookup[type][uri];
            if (info != null && info.url != null) {
                $el.addClass('hoverable');
                $el.click(function() {
                  window.location = info.url;
                  return false;
                });
                // console.log( index + ": " + $el.text() + JSON.stringify(info));
                if (info.blurb != null) {
                    $el.tooltip({
                        title: info.blurb + ' <a href="' + info.url + '">{{ '...read on'|trans }}</a>',
                        html: true,
                        delay: { hide: 350 }
                    });
                }
            }
        });
    }

    function initBibitem(selector) {
        if (bibitemLookup === null) {
            return;
        }

        // link bibitems
        var selector_full = '.dta-bibl';
        if ('' !== selector) {
            selector_full = selector + ' ' + selector_full;
        }

        var url = {{ path('bibliography-index')|json_encode|raw }};
        $( selector_full ).each(function( index ) {
            var $el = $( this );
            var corresp = $el.data('corresp');
            var info = bibitemLookup[corresp];
            if (info != null && info.slug != null) {
                $el.addClass('hoverable');
                $el.click(function() {
                  window.location = url + '/' + info.slug;
                  return false;
                });
            }
        });
    }

    function initEntityGlossaryNote(selector) {
        initNotes(selector);
        initGlossary(selector);
        initEntityRef(selector);
        initBibitem(selector);

        // tooltips on links
        $( '.setTooltip' ).each(function ( index ) {
            var $el = $( this );
            $el.tooltip();
        });
    }
    </script>
{% endmacro %}
